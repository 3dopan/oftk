# 3階層以上のツリー表示 動作確認テストプラン

## テスト目的
Task 6.3で実装した再帰的ツリー表示機能が、3階層以上のディレクトリ構造を正しく表示・操作できることを確認する。

## テスト環境
- **アプリケーション**: Ofkt
- **ビルド**: Debug build
- **実行方法**: `cargo run` または `target/debug/ofkt.exe`

## 前提条件
1. アプリケーションが正常にビルドされている
2. ディレクトリモードが利用可能である
3. テスト用の深い階層構造を持つディレクトリがある

## テストケース

### TC-1: 基本的な3階層表示
**目的**: 3階層のディレクトリが正しく表示されることを確認

**手順**:
1. Ofktを起動
2. ディレクトリモードに切り替え
3. 以下のような構造のディレクトリに移動:
   ```
   ParentDir/
   └── SubDir1/
       └── SubDir2/
           └── SubDir3/
   ```
4. ParentDir を展開
5. SubDir1 を展開
6. SubDir2 を展開

**期待される結果**:
- ParentDir に展開ボタン（▶/▼）が表示される
- SubDir1 に展開ボタンが表示される
- SubDir2 に展開ボタンが表示される
- SubDir3 が表示される
- 各階層のインデントが正しく増加する（20px ずつ）

**判定基準**:
- [ ] 3階層すべてのディレクトリが表示される
- [ ] 各階層で展開ボタンが動作する
- [ ] インデントが階層ごとに増加する

---

### TC-2: 複数サブディレクトリを持つ階層
**目的**: 各階層に複数のサブディレクトリがある場合の表示を確認

**手順**:
1. 以下のような構造のディレクトリに移動:
   ```
   Root/
   ├── DirA/
   │   ├── DirA-1/
   │   │   └── DirA-1-a/
   │   └── DirA-2/
   ├── DirB/
   │   └── DirB-1/
   └── DirC/
   ```
2. Root を展開
3. DirA を展開
4. DirA-1 を展開

**期待される結果**:
- Root配下のDirA, DirB, DirCが表示される
- DirA配下のDirA-1, DirA-2が表示される
- DirA-1配下のDirA-1-aが表示される
- 各階層で正しいインデントが適用される

**判定基準**:
- [ ] 複数のサブディレクトリが正しく表示される
- [ ] 階層が混在しても正しく表示される
- [ ] ソート順が正しい（ディレクトリ優先、アルファベット順）

---

### TC-3: 展開/折りたたみの動作
**目的**: 各階層で展開/折りたたみが正しく動作することを確認

**手順**:
1. 3階層以上のディレクトリ構造を準備
2. 1階層目を展開
3. 2階層目を展開
4. 3階層目を展開
5. 2階層目を折りたたむ
6. 再度2階層目を展開

**期待される結果**:
- 展開時に▼アイコンが表示される
- 折りたたみ時に▶アイコンが表示される
- 折りたたむと配下のディレクトリが非表示になる
- 再展開すると配下のディレクトリが再表示される

**判定基準**:
- [ ] 展開/折りたたみボタンが各階層で動作する
- [ ] アイコンが正しく切り替わる
- [ ] 折りたたみ状態が正しく反映される

---

### TC-4: クリックイベントの検出
**目的**: 各階層のディレクトリクリックが正しく検出されることを確認

**手順**:
1. 3階層以上のディレクトリ構造を展開
2. 1階層目のディレクトリ名をクリック
3. 2階層目のディレクトリ名をクリック
4. 3階層目のディレクトリ名をクリック

**期待される結果**:
- クリックしたディレクトリがハイライト表示される（黄色）
- 各階層でクリックイベントが正しく処理される

**判定基準**:
- [ ] 1階層目のクリックが検出される
- [ ] 2階層目のクリックが検出される
- [ ] 3階層目のクリックが検出される
- [ ] 選択状態が視覚的に表示される

**注意**: 現在の実装では、サブディレクトリ（2階層目以降）のクリックイベントは`selected_index`とは無関係に処理される可能性があります（設計文書参照）。

---

### TC-5: ファイルとディレクトリの混在
**目的**: ディレクトリとファイルが混在する階層での表示を確認

**手順**:
1. 以下のような構造のディレクトリに移動:
   ```
   Root/
   ├── file1.txt
   ├── SubDir/
   │   ├── file2.txt
   │   └── SubSubDir/
   │       └── file3.txt
   └── file4.txt
   ```
2. Root を展開
3. SubDir を展開
4. SubSubDir を展開

**期待される結果**:
- ディレクトリが優先的に表示される（ソート順）
- ファイルにはアイコン（📄）が表示される
- ディレクトリにはアイコン（📁 or 🐧）と展開ボタンが表示される
- ファイルには展開ボタンが表示されない

**判定基準**:
- [ ] ディレクトリとファイルが正しく区別される
- [ ] ソート順が正しい（ディレクトリ優先）
- [ ] ファイルのアイコンが正しく表示される

---

### TC-6: 深い階層（5階層以上）
**目的**: 5階層以上の深い階層でも正しく動作することを確認

**手順**:
1. 5階層以上のディレクトリ構造を準備:
   ```
   Level0/
   └── Level1/
       └── Level2/
           └── Level3/
               └── Level4/
                   └── Level5/
   ```
2. 順次展開していく

**期待される結果**:
- 5階層以上のディレクトリが表示される
- インデントが正しく増加し続ける
- 展開/折りたたみが各階層で動作する

**判定基準**:
- [ ] 5階層以上のディレクトリが表示される
- [ ] インデントが過度に大きくならない（画面外に出ない）
- [ ] パフォーマンスが許容範囲内

---

### TC-7: WSLディレクトリの表示
**目的**: WSLディレクトリが正しく識別・表示されることを確認

**手順**:
1. WSLディレクトリ（例: `\\wsl$\Ubuntu\home\...`）に移動
2. ディレクトリを展開

**期待される結果**:
- WSLディレクトリに🐧アイコンが表示される
- 通常のディレクトリと同様に展開/折りたたみが動作する

**判定基準**:
- [ ] WSLディレクトリが🐧アイコンで表示される
- [ ] 展開/折りたたみが正常に動作する

---

## 既知の制限事項

### インデックス管理の問題
現在の実装では、`selected_index`はルートレベルのエントリのみを対象としています。サブディレクトリ（2階層目以降）のクリックイベントは検出されますが、選択状態の管理は別途対応が必要です。

詳細は `/docs/analysis/file_tree_refactoring_plan.md` の「4. インデックス管理の問題点」を参照してください。

### パフォーマンス
非常に多くのサブディレクトリを持つ階層では、展開時に若干の遅延が発生する可能性があります。これは`std::fs::read_dir()`の呼び出しとソート処理によるものです。

---

## テスト実施記録

### テスト実施日: [実施日を記入]
### テスト実施者: [実施者名を記入]

| テストケース | 結果 | 備考 |
|-------------|------|------|
| TC-1: 基本的な3階層表示 | [ ] PASS / [ ] FAIL | |
| TC-2: 複数サブディレクトリ | [ ] PASS / [ ] FAIL | |
| TC-3: 展開/折りたたみ | [ ] PASS / [ ] FAIL | |
| TC-4: クリックイベント | [ ] PASS / [ ] FAIL | |
| TC-5: ファイル/ディレクトリ混在 | [ ] PASS / [ ] FAIL | |
| TC-6: 深い階層（5階層以上） | [ ] PASS / [ ] FAIL | |
| TC-7: WSLディレクトリ | [ ] PASS / [ ] FAIL | |

### 総合評価
- [ ] すべてのテストケースが合格
- [ ] 一部のテストケースが不合格（詳細を備考欄に記載）
- [ ] 重大な問題が発見された

### 発見された問題

1. **問題タイトル**:
   - 詳細:
   - 再現手順:
   - 期待される動作:
   - 実際の動作:

---

## 次のステップ

### すべてのテストが合格した場合
- Task #71（パフォーマンステスト）に進む

### 問題が発見された場合
- 問題をGitHub Issueとして登録
- 修正タスクを作成
- 修正後に再テストを実施

---

**作成日**: 2026-01-29
**作成者**: qa-agent
**レビュー状況**: 未レビュー
