# ツリー表示パフォーマンステストプラン

## テスト目的
再帰的ツリー表示機能が、大規模ディレクトリや深い階層構造において、許容範囲内のパフォーマンスを維持できることを確認する。

## テスト環境
- **アプリケーション**: Ofkt
- **ビルド**: Release build（`cargo build --release`）
- **測定ツール**: タスクマネージャー（メモリ使用量）、アプリケーション内部のレスポンスタイム

## 前提条件
1. リリースビルドが完了している
2. 大規模ディレクトリへのアクセス権限がある
3. テスト用の深い階層構造を作成できる

---

## テストケース

### PT-1: 大規模ディレクトリの展開（Windows）
**目的**: 多数のサブディレクトリを持つディレクトリでのパフォーマンスを確認

**対象ディレクトリ**:
- `C:\Windows\System32` (1000+ files/dirs)
- `C:\Program Files` (100+ subdirs)
- `C:\Users\[username]\AppData\Local` (多数のサブディレクトリ)

**手順**:
1. Ofktをリリースモードで起動
2. 対象ディレクトリに移動
3. ディレクトリを展開
4. UIの応答性を確認
5. タスクマネージャーでメモリ使用量を確認

**測定項目**:
- 展開にかかる時間（体感）
- UIのフリーズの有無
- メモリ使用量の増加

**合格基準**:
- [ ] 展開時のUIフリーズが1秒未満
- [ ] メモリ使用量が100MB以下の増加
- [ ] スクロールが滑らか

**結果**:
| ディレクトリ | 展開時間 | メモリ増加 | UI応答性 | 判定 |
|-------------|----------|-----------|----------|------|
| C:\Windows\System32 | | | | |
| C:\Program Files | | | | |
| C:\Users\...\AppData | | | | |

---

### PT-2: 深い階層の展開
**目的**: 深い階層（10階層以上）でのパフォーマンスを確認

**準備**:
テスト用の深い階層構造を作成:
```bash
# PowerShellで実行
$path = "C:\Temp\DeepTest"
New-Item -ItemType Directory -Path $path -Force
for ($i = 1; $i -le 15; $i++) {
    $path = Join-Path $path "Level$i"
    New-Item -ItemType Directory -Path $path
}
```

**手順**:
1. 作成したディレクトリ構造をOfktで開く
2. 順次展開していく（Level1 → Level2 → ... → Level15）
3. 各レベルでの応答性を確認
4. インデントが過度に大きくならないか確認

**測定項目**:
- 各階層の展開にかかる時間
- インデントの幅（画面外に出ないか）
- UIの応答性

**合格基準**:
- [ ] 各階層の展開が即座に行われる（0.1秒未満）
- [ ] 15階層目でもインデントが画面内に収まる
- [ ] UIがフリーズしない

**結果**:
| 階層レベル | 展開時間 | インデント幅 | 判定 |
|-----------|----------|--------------|------|
| Level 5 | | | |
| Level 10 | | | |
| Level 15 | | | |

**インデント幅の確認**:
- Level 15のインデント: `15 * 20.0px = 300px`
- 画面幅が1920pxの場合、許容範囲内

---

### PT-3: 多数のサブディレクトリを持つ階層の展開
**目的**: 1つのディレクトリに多数のサブディレクトリがある場合のパフォーマンスを確認

**準備**:
テスト用のディレクトリ構造を作成:
```powershell
# PowerShellで実行
$root = "C:\Temp\ManyDirsTest"
New-Item -ItemType Directory -Path $root -Force
for ($i = 1; $i -le 100; $i++) {
    New-Item -ItemType Directory -Path (Join-Path $root "Dir$i")
}
```

**手順**:
1. 作成したディレクトリをOfktで開く
2. ルートディレクトリを展開
3. スクロール動作を確認
4. メモリ使用量を確認

**測定項目**:
- 展開にかかる時間
- スクロールの滑らかさ
- メモリ使用量

**合格基準**:
- [ ] 100個のサブディレクトリが1秒以内に表示される
- [ ] スクロールが滑らか
- [ ] メモリ使用量が50MB以下の増加

**結果**:
- 展開時間: [記入]
- スクロール性能: [ ] 滑らか / [ ] カクつく
- メモリ増加: [記入]
- 判定: [ ] PASS / [ ] FAIL

---

### PT-4: 複数階層の同時展開
**目的**: 複数の階層を同時に展開した場合のパフォーマンスを確認

**手順**:
1. 大規模ディレクトリ（例: C:\Windows）を開く
2. 複数のサブディレクトリを順次展開
3. 5つ以上のディレクトリを展開した状態を維持
4. スクロールやUIの応答性を確認

**測定項目**:
- 複数展開時の応答性
- メモリ使用量の累積増加
- UIのフリーズの有無

**合格基準**:
- [ ] 複数展開してもUIが応答する
- [ ] メモリリークがない
- [ ] スクロールが滑らか

**結果**:
- 展開したディレクトリ数: [記入]
- メモリ使用量: [記入]
- UI応答性: [ ] 良好 / [ ] やや遅延 / [ ] フリーズ
- 判定: [ ] PASS / [ ] FAIL

---

### PT-5: 展開/折りたたみの繰り返し
**目的**: 展開/折りたたみを繰り返した場合のメモリリークを確認

**手順**:
1. 大規模ディレクトリを開く
2. ディレクトリを展開
3. 折りたたむ
4. 再展開
5. この操作を10回繰り返す
6. メモリ使用量を記録

**測定項目**:
- メモリ使用量の推移
- メモリリークの有無

**合格基準**:
- [ ] メモリ使用量が線形増加しない
- [ ] 10回繰り返してもメモリが初回の2倍以下

**結果**:
| 繰り返し回数 | メモリ使用量 |
|-------------|-------------|
| 初回 | |
| 5回目 | |
| 10回目 | |

- メモリリーク: [ ] なし / [ ] あり
- 判定: [ ] PASS / [ ] FAIL

---

### PT-6: 仮想化レンダリングの動作確認
**目的**: 100件以上のエントリで仮想化レンダリングが動作するか確認

**手順**:
1. 100個以上のサブディレクトリを持つディレクトリを開く（PT-3の構造を利用）
2. ディレクトリを展開
3. スクロールの動作を確認

**測定項目**:
- スクロールの滑らかさ
- 表示されるアイテム数
- CPUとメモリの使用率

**合格基準**:
- [ ] スクロールが滑らか
- [ ] 仮想化により表示範囲外のアイテムがレンダリングされない
- [ ] CPU使用率が過度に上昇しない

**結果**:
- スクロール性能: [ ] 滑らか / [ ] カクつく
- 仮想化の動作: [ ] 正常 / [ ] 未確認
- CPU使用率: [記入]
- 判定: [ ] PASS / [ ] FAIL

**注意**: 現在の実装では、再帰的ツリー表示において仮想化レンダリングが適切に動作しない可能性があります。大規模ディレクトリで問題が発生した場合、遅延読み込みやキャッシュ機構の導入を検討してください。

---

## パフォーマンス最適化の提案

### 現在の実装の問題点
1. **再帰的ツリーでは仮想化が困難**: 階層が動的に変化するため、`show_rows`が使えない
2. **ソート処理**: 各階層で`Vec::sort_by()`を呼び出している
3. **ファイルシステムアクセス**: `std::fs::read_dir()`が同期的に実行される

### 最適化案
1. **遅延読み込み**: 展開されたディレクトリのみ読み込む（現在の実装で対応済み）
2. **キャッシュ機構**: 一度読み込んだディレクトリ内容をキャッシュ
3. **非同期読み込み**: バックグラウンドでディレクトリを読み込む
4. **エントリ数の制限**: 1つのディレクトリに表示するエントリ数を制限（例: 最大500件）

---

## テスト実施記録

### テスト実施日: [実施日を記入]
### テスト実施者: [実施者名を記入]
### ビルド: Release (`cargo build --release`)

| テストケース | 結果 | 備考 |
|-------------|------|------|
| PT-1: 大規模ディレクトリ | [ ] PASS / [ ] FAIL | |
| PT-2: 深い階層 | [ ] PASS / [ ] FAIL | |
| PT-3: 多数のサブディレクトリ | [ ] PASS / [ ] FAIL | |
| PT-4: 複数階層の同時展開 | [ ] PASS / [ ] FAIL | |
| PT-5: 展開/折りたたみの繰り返し | [ ] PASS / [ ] FAIL | |
| PT-6: 仮想化レンダリング | [ ] PASS / [ ] FAIL | |

### 総合評価
- [ ] すべてのテストケースが合格
- [ ] 一部のテストケースが不合格（詳細を備考欄に記載）
- [ ] パフォーマンス最適化が必要

### システム情報
- CPU: [記入]
- メモリ: [記入]
- OS: Windows [バージョン]
- 画面解像度: [記入]

---

## 次のステップ

### すべてのテストが合格した場合
- Task #72（選択状態管理の改善検討）に進む

### パフォーマンス問題が発見された場合
- 問題を詳細に記録
- 最適化案を検討
- 最適化タスクを作成

---

**作成日**: 2026-01-29
**作成者**: qa-agent
**レビュー状況**: 未レビュー
